{%- if messages[0]['role'] == 'system' -%}
    {%- set system_message = messages[0]['content'] -%}
    {%- set messages = messages[1:] -%}
{%- else -%}
    {%- set system_message = '' -%}
{%- endif -%}

{%- if system_message -%}
<|im_start|>system
{{ system_message }}<|im_end|>
{%- endif -%}

{%- for message in messages -%}
    {%- if message['role'] == 'user' -%}
<|im_start|>user
{{ message['content'] }}<|im_end|>
    {%- elif message['role'] == 'assistant' -%}
<|im_start|>assistant
        {%- if message.get('reasoning_content') -%}
<think>
{{ message['reasoning_content'] }}
</think>
        {%- endif -%}
{{ message['content'] }}<|im_end|>
    {%- endif -%}
{%- endfor -%}

{%- if add_generation_prompt -%}
<|im_start|>assistant
    {%- if enable_thinking is not defined or enable_thinking -%}
<think>
    {%- endif -%}
{%- endif -%}